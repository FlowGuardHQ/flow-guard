{
  "contractName": "ProposalCovenant",
  "constructorInputs": [
    {
      "name": "vaultId",
      "type": "bytes32"
    },
    {
      "name": "signer1Hash",
      "type": "bytes20"
    },
    {
      "name": "signer2Hash",
      "type": "bytes20"
    },
    {
      "name": "signer3Hash",
      "type": "bytes20"
    },
    {
      "name": "requiredApprovals",
      "type": "int"
    }
  ],
  "abi": [
    {
      "name": "approve",
      "inputs": [
        {
          "name": "approverSig",
          "type": "sig"
        },
        {
          "name": "approverPubkey",
          "type": "pubkey"
        }
      ]
    },
    {
      "name": "execute",
      "inputs": []
    },
    {
      "name": "cancel",
      "inputs": [
        {
          "name": "sig1",
          "type": "sig"
        },
        {
          "name": "pubkey1",
          "type": "pubkey"
        },
        {
          "name": "sig2",
          "type": "sig"
        },
        {
          "name": "pubkey2",
          "type": "pubkey"
        }
      ]
    },
    {
      "name": "expire",
      "inputs": []
    }
  ],
  "bytecode": "OP_5 OP_PICK OP_0 OP_NUMEQUAL OP_IF OP_0 OP_UTXOTOKENCOMMITMENT OP_DUP OP_1 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_DROP OP_BIN2NUM OP_OVER OP_2 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_DROP OP_BIN2NUM OP_10 OP_PICK OP_HASH160 OP_DUP OP_6 OP_ROLL OP_EQUAL OP_OVER OP_7 OP_ROLL OP_EQUAL OP_BOOLOR OP_SWAP OP_6 OP_ROLL OP_EQUAL OP_BOOLOR OP_VERIFY OP_6 OP_ROLL OP_7 OP_ROLL OP_CHECKSIGVERIFY OP_SWAP OP_0 OP_NUMEQUALVERIFY OP_1ADD OP_0 OP_OVER OP_5 OP_ROLL OP_GREATERTHANOREQUAL OP_IF OP_DROP OP_1 OP_ENDIF OP_2 OP_PICK OP_1 OP_SPLIT OP_DROP OP_SWAP OP_1 OP_NUM2BIN OP_CAT OP_SWAP OP_1 OP_NUM2BIN OP_CAT OP_SWAP OP_3 OP_SPLIT OP_NIP 25 OP_SPLIT OP_DROP OP_CAT 000000000000 OP_CAT OP_0 OP_OUTPUTTOKENCOMMITMENT OP_EQUALVERIFY OP_0 OP_OUTPUTTOKENCATEGORY OP_0 OP_UTXOTOKENCATEGORY OP_EQUALVERIFY OP_0 OP_OUTPUTBYTECODE OP_0 OP_UTXOBYTECODE OP_EQUAL OP_NIP OP_NIP OP_ELSE OP_5 OP_PICK OP_1 OP_NUMEQUAL OP_IF OP_0 OP_UTXOTOKENCOMMITMENT OP_DUP OP_1 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_DROP OP_BIN2NUM OP_SWAP OP_9 OP_SPLIT OP_NIP OP_5 OP_SPLIT OP_DROP OP_BIN2NUM OP_SWAP OP_1 OP_NUMEQUALVERIFY OP_TXLOCKTIME OP_LESSTHANOREQUAL OP_VERIFY 0000000000000000000000000000000000000000000000000000000000000000 OP_EQUAL OP_NOT OP_VERIFY OP_2DROP OP_2DROP OP_DROP OP_1 OP_ELSE OP_5 OP_PICK OP_2 OP_NUMEQUAL OP_IF OP_0 OP_UTXOTOKENCOMMITMENT OP_DUP OP_1 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_DROP OP_BIN2NUM OP_9 OP_PICK OP_HASH160 OP_12 OP_PICK OP_HASH160 OP_OVER OP_6 OP_PICK OP_EQUAL OP_2 OP_PICK OP_8 OP_PICK OP_EQUAL OP_BOOLOR OP_2 OP_PICK OP_9 OP_PICK OP_EQUAL OP_BOOLOR OP_VERIFY OP_DUP OP_6 OP_ROLL OP_EQUAL OP_OVER OP_7 OP_ROLL OP_EQUAL OP_BOOLOR OP_OVER OP_7 OP_ROLL OP_EQUAL OP_BOOLOR OP_VERIFY OP_EQUAL OP_NOT OP_VERIFY OP_5 OP_ROLL OP_6 OP_ROLL OP_CHECKSIGVERIFY OP_5 OP_ROLL OP_6 OP_ROLL OP_CHECKSIGVERIFY OP_DUP OP_0 OP_NUMEQUAL OP_SWAP OP_1 OP_NUMEQUAL OP_BOOLOR OP_VERIFY OP_DUP OP_1 OP_SPLIT OP_DROP OP_3 OP_CAT OP_SWAP OP_2 OP_SPLIT OP_NIP 26 OP_SPLIT OP_DROP OP_CAT 000000000000 OP_CAT OP_0 OP_OUTPUTTOKENCOMMITMENT OP_EQUALVERIFY OP_0 OP_OUTPUTTOKENCATEGORY OP_0 OP_UTXOTOKENCATEGORY OP_EQUALVERIFY OP_0 OP_OUTPUTBYTECODE OP_0 OP_UTXOBYTECODE OP_EQUAL OP_NIP OP_NIP OP_NIP OP_ELSE OP_5 OP_ROLL OP_3 OP_NUMEQUALVERIFY OP_0 OP_UTXOTOKENCOMMITMENT OP_DUP OP_1 OP_SPLIT OP_NIP OP_1 OP_SPLIT OP_DROP OP_BIN2NUM OP_OVER OP_4 OP_SPLIT OP_NIP OP_5 OP_SPLIT OP_DROP OP_BIN2NUM OP_SWAP OP_0 OP_NUMEQUALVERIFY OP_DUP OP_0 OP_GREATERTHAN OP_VERIFY OP_TXLOCKTIME OP_LESSTHANOREQUAL OP_VERIFY OP_DUP OP_1 OP_SPLIT OP_DROP OP_4 OP_CAT OP_SWAP OP_2 OP_SPLIT OP_NIP 26 OP_SPLIT OP_DROP OP_CAT 000000000000 OP_CAT OP_0 OP_OUTPUTTOKENCOMMITMENT OP_EQUALVERIFY OP_0 OP_OUTPUTTOKENCATEGORY OP_0 OP_UTXOTOKENCATEGORY OP_EQUALVERIFY OP_0 OP_OUTPUTBYTECODE OP_0 OP_UTXOBYTECODE OP_EQUALVERIFY OP_2DROP OP_2DROP OP_DROP OP_1 OP_ENDIF OP_ENDIF OP_ENDIF",
  "source": "/**\n * ProposalCovenant — Production Grade\n *\n * ENFORCEABILITY: [ENFORCEABLE-NOW]\n *\n * PURPOSE: Manage spending proposal lifecycle\n * - Track M-of-N approvals with signer identity validation\n * - Enforce status transitions (PENDING → APPROVED → EXECUTED)\n * - Enforce execution timelock (CLTV)\n * - Cancel by M-of-N, expire after voting deadline\n *\n * NFT COMMITMENT (40 bytes — within CashTokens 40-byte limit):\n *   [0]:     version (uint8)\n *   [1]:     status (uint8: 0=PENDING, 1=APPROVED, 2=EXECUTED, 3=CANCELLED, 4=EXPIRED)\n *   [2]:     approval_count (uint8)\n *   [3]:     required_approvals (uint8)\n *   [4-8]:   voting_end_timestamp (5 bytes)\n *   [9-13]:  execution_timelock (5 bytes)\n *   [14-33]: payout_hash (bytes20)\n *   [34-39]: reserved\n *\n * CONTRACT PARAMETERS (compiled into bytecode, immutable):\n *   vaultId           — links proposal to vault\n *   signer1Hash       — hash160 of vault signer 1\n *   signer2Hash       — hash160 of vault signer 2\n *   signer3Hash       — hash160 of vault signer 3\n *   requiredApprovals — M in M-of-N\n */\n\npragma cashscript ^0.13.0;\n\ncontract ProposalCovenant(\n    bytes32 vaultId,\n    bytes20 signer1Hash,\n    bytes20 signer2Hash,\n    bytes20 signer3Hash,\n    int requiredApprovals\n) {\n    /**\n     * approve() — Vault signer adds their approval\n     */\n    function approve(sig approverSig, pubkey approverPubkey) {\n        bytes c = tx.inputs[0].nftCommitment;\n        int status        = int(c.split(1)[1].split(1)[0]);\n        int approvalCount = int(c.split(2)[1].split(1)[0]);\n\n        bytes20 pkHash = hash160(approverPubkey);\n        require(pkHash == signer1Hash || pkHash == signer2Hash || pkHash == signer3Hash);\n        require(checkSig(approverSig, approverPubkey));\n        require(status == 0); // PENDING\n\n        int newCount = approvalCount + 1;\n        int newStatus = 0;\n        if (newCount >= requiredApprovals) { newStatus = 1; } // APPROVED\n\n        bytes newCommitment =\n            c.split(1)[0] +\n            toPaddedBytes(newStatus, 1) +\n            toPaddedBytes(newCount, 1) +\n            c.split(3)[1].split(37)[0] +\n            0x000000000000;\n\n        require(tx.outputs[0].nftCommitment == newCommitment);\n        require(tx.outputs[0].tokenCategory == tx.inputs[0].tokenCategory);\n        require(tx.outputs[0].lockingBytecode == tx.inputs[0].lockingBytecode);\n    }\n\n    /**\n     * execute() — Execute an approved proposal\n     *\n     * ProposalNFT is burned after execution.\n     */\n    function execute() {\n        bytes c = tx.inputs[0].nftCommitment;\n        int status            = int(c.split(1)[1].split(1)[0]);\n        int executionTimelock = int(c.split(9)[1].split(5)[0]);\n\n        require(status == 1); // APPROVED\n        require(tx.locktime >= executionTimelock);\n        require(vaultId != 0x0000000000000000000000000000000000000000000000000000000000000000);\n    }\n\n    /**\n     * cancel() — Cancel a pending or approved proposal (M-of-N)\n     */\n    function cancel(sig sig1, pubkey pubkey1, sig sig2, pubkey pubkey2) {\n        bytes c = tx.inputs[0].nftCommitment;\n        int status = int(c.split(1)[1].split(1)[0]);\n\n        bytes20 pk1Hash = hash160(pubkey1);\n        bytes20 pk2Hash = hash160(pubkey2);\n\n        require(pk1Hash == signer1Hash || pk1Hash == signer2Hash || pk1Hash == signer3Hash);\n        require(pk2Hash == signer1Hash || pk2Hash == signer2Hash || pk2Hash == signer3Hash);\n        require(pk1Hash != pk2Hash);\n\n        require(checkSig(sig1, pubkey1));\n        require(checkSig(sig2, pubkey2));\n\n        require(status == 0 || status == 1); // PENDING or APPROVED\n\n        bytes newCommitment =\n            c.split(1)[0] +\n            0x03 +\n            c.split(2)[1].split(38)[0] +\n            0x000000000000;\n\n        require(tx.outputs[0].nftCommitment == newCommitment);\n        require(tx.outputs[0].tokenCategory == tx.inputs[0].tokenCategory);\n        require(tx.outputs[0].lockingBytecode == tx.inputs[0].lockingBytecode);\n    }\n\n    /**\n     * expire() — Mark proposal expired after voting deadline (permissionless)\n     */\n    function expire() {\n        bytes c = tx.inputs[0].nftCommitment;\n        int status    = int(c.split(1)[1].split(1)[0]);\n        int votingEnd = int(c.split(4)[1].split(5)[0]);\n\n        require(status == 0); // PENDING\n        require(votingEnd > 0);\n        require(tx.locktime >= votingEnd);\n\n        bytes newCommitment =\n            c.split(1)[0] +\n            0x04 +\n            c.split(2)[1].split(38)[0] +\n            0x000000000000;\n\n        require(tx.outputs[0].nftCommitment == newCommitment);\n        require(tx.outputs[0].tokenCategory == tx.inputs[0].tokenCategory);\n        require(tx.outputs[0].lockingBytecode == tx.inputs[0].lockingBytecode);\n    }\n}\n",
  "debug": {
    "bytecode": "5579009c6300cf76517f77517f758178527f77517f75815a79a976567a8778577a879b7c567a879b69567a577aad7c009d8b0078557aa2637551685279517f757c51807e7c51807e7c537f7701257f757e060000000000007e00d28800d100ce8800cd00c7877777675579519c6300cf76517f77517f75817c597f77557f75817c519dc5a1692000000000000000000000000000000000000000000000000000000000000000008791696d6d7551675579529c6300cf76517f77517f75815979a95c79a97856798752795879879b52795979879b6976567a8778577a879b78577a879b69879169557a567aad557a567aad76009c7c519c9b6976517f75537e7c527f7701267f757e060000000000007e00d28800d100ce8800cd00c78777777767557a539d00cf76517f77517f758178547f77557f75817c009d7600a069c5a16976517f75547e7c527f7701267f757e060000000000007e00d28800d100ce8800cd00c7886d6d7551686868",
    "sourceMap": "42:4:66:5;;;;;43:28:43:29;:18::44:1;44:32:44:33:0;:40::41;:32::42:1;:::45;:52::53:0;:32::54:1;:::57;:28::58;45:32:45:33:0;:40::41;:32::42:1;:::45;:52::53:0;:32::54:1;:::57;:28::58;47:33:47:47:0;;:25::48:1;48:16:48:22:0;:26::37;;:16:::1;:41::47:0;:51::62;;:41:::1;:16;:66::72:0;:76::87;;:66:::1;:16;:8::89;49:25:49:36:0;;:38::52;;:8::55:1;50:16:50:22:0;:26::27;:8::29:1;52:23:52:40;53:24:53:25:0;54:12:54:20;:24::41;;:12:::1;:43::61:0;:45::59:1;;:43::61;57:12:57:13:0;;:20::21;:12::22:1;:::25;58:26:58:35:0;:37::38;:12::39:1;57;59:26:59:34:0;:36::37;:12::38:1;57;60::60:13:0;:20::21;:12::22:1;:::25;:32::34:0;:12::35:1;:::38;57;61::61:26:0;57::::1;63:27:63:28:0;:16::43:1;:8::62;64:27:64:28:0;:16::43:1;:57::58:0;:47::73:1;:8::75;65:27:65:28:0;:16::45:1;:59::60:0;:49::77:1;:8::79;42:4:66:5;;;73::81::0;;;;;74:28:74:29;:18::44:1;75:36:75:37:0;:44::45;:36::46:1;:::49;:56::57:0;:36::58:1;:::61;:32::62;76:36:76:37:0;:44::45;:36::46:1;:::49;:56::57:0;:36::58:1;:::61;:32::62;78:16:78:22:0;:26::27;:8::29:1;79:16:79:27:0;:::48:1;:8::50;80:27:80:93:0;:16:::1;;:8::95;73:4:81:5;;;;;86::111::0;;;;;87:28:87:29;:18::44:1;88:25:88:26:0;:33::34;:25::35:1;:::38;:45::46:0;:25::47:1;:::50;:21::51;90:34:90:41:0;;:26::42:1;91:34:91:41:0;;:26::42:1;93:16:93:23:0;:27::38;;:16:::1;:42::49:0;;:53::64;;:42:::1;:16;:68::75:0;;:79::90;;:68:::1;:16;:8::92;94:16:94:23:0;:27::38;;:16:::1;:42::49:0;:53::64;;:42:::1;:16;:68::75:0;:79::90;;:68:::1;:16;:8::92;95:16:95:34;;:8::36;97:25:97:29:0;;:31::38;;:8::41:1;98:25:98:29:0;;:31::38;;:8::41:1;100:16:100:22:0;:26::27;:16:::1;:31::37:0;:41::42;:31:::1;:16;:8::44;103:12:103:13:0;:20::21;:12::22:1;:::25;104::104:16:0;103::::1;105::105:13:0;:20::21;:12::22:1;:::25;:32::34:0;:12::35:1;:::38;103;106::106:26:0;103::::1;108:27:108:28:0;:16::43:1;:8::62;109:27:109:28:0;:16::43:1;:57::58:0;:47::73:1;:8::75;110:27:110:28:0;:16::45:1;:59::60:0;:49::77:1;:8::79;86:4:111:5;;;;116::134::0;;;;117:28:117:29;:18::44:1;118:28:118:29:0;:36::37;:28::38:1;:::41;:48::49:0;:28::50:1;:::53;:24::54;119:28:119:29:0;:36::37;:28::38:1;:::41;:48::49:0;:28::50:1;:::53;:24::54;121:16:121:22:0;:26::27;:8::29:1;122:16:122:25:0;:28::29;:16:::1;:8::31;123:16:123:27:0;:::40:1;:8::42;126:12:126:13:0;:20::21;:12::22:1;:::25;127::127:16:0;126::::1;128::128:13:0;:20::21;:12::22:1;:::25;:32::34:0;:12::35:1;:::38;126;129::129:26:0;126::::1;131:27:131:28:0;:16::43:1;:8::62;132:27:132:28:0;:16::43:1;:57::58:0;:47::73:1;:8::75;133:27:133:28:0;:16::45:1;:59::60:0;:49::77:1;:8::79;116:4:134:5;;;;32:0:135:1;;",
    "logs": [],
    "requires": [
      {
        "ip": 45,
        "line": 48
      },
      {
        "ip": 50,
        "line": 49
      },
      {
        "ip": 53,
        "line": 50
      },
      {
        "ip": 89,
        "line": 63
      },
      {
        "ip": 94,
        "line": 64
      },
      {
        "ip": 100,
        "line": 65
      },
      {
        "ip": 128,
        "line": 78
      },
      {
        "ip": 131,
        "line": 79
      },
      {
        "ip": 135,
        "line": 80
      },
      {
        "ip": 178,
        "line": 93
      },
      {
        "ip": 193,
        "line": 94
      },
      {
        "ip": 196,
        "line": 95
      },
      {
        "ip": 201,
        "line": 97
      },
      {
        "ip": 206,
        "line": 98
      },
      {
        "ip": 214,
        "line": 100
      },
      {
        "ip": 233,
        "line": 108
      },
      {
        "ip": 238,
        "line": 109
      },
      {
        "ip": 244,
        "line": 110
      },
      {
        "ip": 272,
        "line": 121
      },
      {
        "ip": 276,
        "line": 122
      },
      {
        "ip": 279,
        "line": 123
      },
      {
        "ip": 298,
        "line": 131
      },
      {
        "ip": 303,
        "line": 132
      },
      {
        "ip": 308,
        "line": 133
      }
    ]
  },
  "compiler": {
    "name": "cashc",
    "version": "0.13.0-next.3"
  },
  "updatedAt": "2026-02-26T00:17:26.079Z"
}